# PokeTier - Design Document (Phase 0: 初期ティアリスト作成システム)

## 概要

### 背景・課題
ポケポケコミュニティにおいて、デッキ強度の議論に使用するティアリスト作成の課題：
- 既存汎用ツールはポケポケ特有のニーズ（シーズン管理、デッキ画像合成）に対応していない
- カード組み合わせ表現（例：リザニンフ = リザードンex + ニンフィアex）の画像が作成できない
- コミュニティ全体の傾向（集計ティアリスト）が見えない

### 解決方針（Phase 0）
**ポケポケ特化の基本的なティアリスト作成システム**を構築し、以下で差別化：
1. **デッキ画像自動生成（ImageComposition）**: カード組み合わせから美しいデッキ画像を生成
2. **集計ティアリスト（ConsensusTierList）**: 全ユーザーの配置データから傾向を分析・表示
3. **シーズン管理（SeasonAggregate）**: アクティブシーズンに対応したデッキ・ティアリスト管理

## アーキテクチャ設計（ユビキタス言語準拠）

### システム構成の決定（Phase 0）
```
Frontend (Next.js SSG) → API (Go/Workers) → Database (D1) + Storage (R2)
                      ↘ Cloudflare Stack (完全無料枠) (仮)
```

**選定理由**:
- **SSG**: SEO最適化、高速表示、Cloudflare連携
- **Cloudflare Workers**: 無料枠、Go対応、グローバル配信 (仮)
- **D1（SQLite）**: 無料枠、シンプルな運用 (仮)
- **R2**: 無料枠での画像ストレージ (仮)

### ドメインモデル設計（ユビキタス言語準拠）

#### 集約境界とエンティティ関係
```
SeasonAggregate → DeckAggregate → TierPlacement ← TierListAggregate
      ↓              ↓               ↑
ExpansionAggregate  Card         StatisticsCalculation
```

**ユビキタス言語マッピング**:
- **Season（シーズン）**: ポケポケのランクマッチ環境期間
- **Deck（デッキ）**: ティアリストで配置される構築要素（カードの組み合わせ）
- **TierList（ティアリスト）**: ユーザーが作成するデッキ強度ランキング
- **TierPlacement（ティア配置）**: TierListとDeckの多対多関係
- **TierRank（ティアランク）**: SS/S/A/B/C/D/E の7段階評価

**設計判断**:
- **UUID主キー**: D1での一意性担保、予測困難性
- **シーズン分離**: 環境変化への対応、データ整理
- **集約境界**: DDD原則に基づく整合性境界

### 技術選定の根拠（Phase 0制約）

#### Cloudflare Stack全面採用 (仮)
**選定理由**:
- **完全無料枠**: 初期コスト0円での運用
- **一元管理**: Pages + Workers + D1 + R2 の統合環境
- **グローバル配信**: エッジでの高速処理

**制約・トレードオフ**:
- **D1制限**: 100MB、基本SQLのみ
- **Workers制限**: CPU時間10ms、メモリ128MB
- **機能制約**: 高度な統計処理は将来に延期

## 主要プロセスの設計判断

### 1. 画像合成システム（ImageComposition）

#### Phase 0 アプローチ
**シンプルな横並び合成 + R2キャッシュ**

**判断理由**:
- **シンプル実装**: 複雑なレイアウト計算を避け、横並びのみ
- **固定サイズ**: レスポンシブ対応は CSS で調整
- **R2保存**: 一度生成した画像は永続キャッシュ

#### キャッシュ戦略
- **生成時**: Cloudflare R2 に永続保存（`decks/{deck_id}.png`）
- **配信**: CDN 経由（TTL: 24時間）
- **重複チェック**: デッキIDベース判定

### 2. 集計ティアリスト生成（StatisticsCalculation）

#### Phase 0 集計アルゴリズム
**基本的な平均値計算をSQLで実行**

**設計判断**:
- **期間制限**: 直近7日間のデータのみ（環境変化への適応）
- **最低出現回数**: ノイズ除去、統計的有意性
- **シンプル計算**: D1制限内での処理

#### 更新戦略（Phase 0）
- **手動更新**: 定期実行（cron）での更新
- **キャッシュ**: メモリキャッシュ（Workers KV検討）

### 3. シーズン管理システム（SeasonAggregate）

#### Phase 0 シーズン戦略
**手動でのシーズン切り替え管理**

**判断理由**:
- **手動切り替え**: 自動化は Phase 1 以降
- **シンプル移行**: データ持ち越しは統計のみ
- **一意制約**: アクティブシーズンは常に1つ

## パフォーマンス設計（Phase 0制約）

### スケーラビリティ戦略

#### 無料枠内での最適化
```
Cloudflare CDN → Workers (10ms CPU) → D1 (100MB) → R2 (10GB) (仮)
```

#### 制限対応
- **D1制限**: 複雑なクエリ回避、事前集計
- **Workers制限**: 軽量処理、重い処理は非同期化検討
- **R2制限**: 画像サイズ最適化、WebP形式

#### パフォーマンス目標（Phase 0）
- **ページ読み込み**: 3秒以内
- **API レスポンス**: 1秒以内
- **画像生成**: 3秒以内
- **同時ユーザー**: 100人対応

## 品質担保（Phase 0 最小限）

### テスト戦略

#### Phase 0 重点領域
- **Unit Tests**: 画像合成ロジック、統計計算ロジック
- **Integration Tests**: 主要APIエンドポイント
- **Manual Testing**: E2E フロー確認

#### 品質メトリクス（Phase 0）
- **コードカバレッジ**: 70%以上
- **Lighthouse スコア**: 80点以上
- **基本的なアクセシビリティ**: WCAG 2.1 A準拠

### 監視・運用（Phase 0）

#### 監視項目
- **Cloudflare Analytics**: トラフィック監視
- **Workers Analytics**: API使用状況
- **手動監視**: エラーログ確認

## セキュリティ設計（Phase 0 基本対応）

### 基本セキュリティ

#### Phase 0 対策
- **HTTPS強制**: Cloudflare SSL
- **入力検証**: 全API入力のバリデーション
- **SQL対策**: パラメーター化クエリ
- **レート制限**: Workers による基本制限

#### 認証戦略（Phase 0）
- **匿名利用**: ユーザー認証は実装しない
- **作成者名**: 任意入力（バリデーションのみ）
- **管理機能**: 基本的な管理APIのみ

## 運用設計（Phase 0）

### デプロイ戦略

#### CI/CD パイプライン（簡易版）
```
Git Push → GitHub Actions → Build → Deploy to Cloudflare (仮)
```

#### 環境分離（Phase 0）
- **Development**: ローカル開発（wrangler dev）
- **Production**: Cloudflare 本番環境 (仮)

### コスト最適化（Phase 0 = 完全無料）

#### Cloudflare 無料枠
- **Pages**: 無制限（静的サイト）
- **Workers**: 100,000 リクエスト/日
- **D1**: 100MB ストレージ
- **R2**: 10GB ストレージ

#### スケーリング計画
1. **Phase 0**: 完全無料枠内（～100ユーザー）
2. **Phase 1**: 有料プラン検討（～1000ユーザー）

## Phase 0 での制約・割り切り

### 実装しない機能
- **ユーザー認証**: 匿名利用のみ
- **高度な統計**: 基本的な集計のみ
- **リアルタイム更新**: 手動更新
- **複雑な画像レイアウト**: 横並びのみ
- **管理画面**: 最小限のAPI

### 技術的制約
- **D1制限**: 複雑なクエリ、大量データ処理不可
- **Workers制限**: 重い処理、長時間処理不可
- **無料枠制限**: スケール時のコスト発生

### 運用制約
- **手動運用**: 自動化は最小限
- **基本監視**: 高度な監視は未実装
- **サポート**: コミュニティベース

## 今後の拡張性（Phase 1以降）

### 機能拡張ポイント
1. **ユーザー認証**: 個人ティアリスト管理
2. **デッキ詳細**: カードリスト、解説
3. **コミュニティ**: ユーザー間交流
4. **高度な統計**: トレンド分析、予測

### アーキテクチャ進化
- **データベース**: PostgreSQL への移行検討
- **キャッシュ**: Redis 導入
- **認証**: JWT 実装
- **監視**: 本格的な監視システム
